# RÃ¨gles du projet FFP3 Datas - Plateforme Aquaponie & IoT

## ğŸ¯ Vue d'ensemble du projet

Application PHP 8+ de supervision d'un systÃ¨me d'aquaponie avec ESP32, utilisant Slim 4, Twig et Monolog.

## ğŸ—ï¸ Architecture

### Stack technique
- **Framework**: Slim 4 (routing, middleware)
- **Template**: Twig (Bootstrap 5)
- **Logs**: Monolog
- **Tests**: PHPUnit
- **Base de donnÃ©es**: MySQL/MariaDB avec PDO
- **DÃ©pendances**: GÃ©rÃ©es via Composer

### Structure des dossiers
```
â”œâ”€â”€ public/              # Front-controller Slim (point d'entrÃ©e)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ Config/          # Configuration (.env, PDO, TableConfig)
â”‚   â”œâ”€â”€ Controller/      # Endpoints HTTP (callbacks Slim)
â”‚   â”œâ”€â”€ Domain/          # DTO mÃ©tier (ex: SensorData)
â”‚   â”œâ”€â”€ Repository/      # AccÃ¨s base de donnÃ©es (PDO)
â”‚   â”œâ”€â”€ Service/         # Services mÃ©tier (logs, stats, pompes, notifications)
â”‚   â””â”€â”€ Command/         # Jobs CRON
â”œâ”€â”€ templates/           # Vues Twig
â””â”€â”€ tests/              # Tests unitaires PHPUnit
```

## ğŸ—„ï¸ Environnements et Tables

### Environnements
- **PRODUCTION**: Tables `ffp3Data` et `ffp3Outputs`
- **TEST**: Tables `ffp3Data2` et `ffp3Outputs2`

### Configuration via .env
- Variable `ENV=prod` ou `ENV=test` dÃ©termine l'environnement par dÃ©faut
- **TOUJOURS** utiliser `TableConfig::getEnvironment()` et `TableConfig::getDataTable()` pour accÃ©der aux bonnes tables
- Ne JAMAIS coder en dur les noms de tables

### Routes
- Routes PROD: `/aquaponie`, `/dashboard`, `/post-data`, etc.
- Routes TEST: `/aquaponie-test`, `/dashboard-test`, `/post-data-test`, etc.

## â° Gestion du fuseau horaire

**IMPORTANT**: Le fuseau horaire est unifiÃ© sur **Europe/Paris** pour tout le projet.

- Configuration centralisÃ©e via `APP_TIMEZONE=Europe/Paris` dans `.env`
- Le timezone est configurÃ© automatiquement par `Env::load()`
- **Ne JAMAIS** appeler `date_default_timezone_set()` manuellement dans les contrÃ´leurs
- Highcharts dans les templates Twig doit utiliser moment-timezone avec Europe/Paris

## ğŸ”’ SÃ©curitÃ©

### API POST `/post-data`
- Authentification par `api_key` (legacy) ET/OU signature HMAC-SHA256
- Variables `.env`: `API_KEY`, `API_SIG_SECRET`, `SIG_VALID_WINDOW`
- Validation via `SignatureValidator` service

### Fichier .env
- âš ï¸ **PARTICULARITÃ‰**: Le `.env` est versionnÃ© dans Git pour ce projet (contrairement aux conventions usuelles)
- Assurer la protection des informations sensibles par d'autres moyens si nÃ©cessaire

## ğŸ“‹ Conventions de code

### PHP
- Version minimale: PHP 8.1
- PSR-4 autoloading via Composer
- Utiliser le type hinting strict
- PrÃ©fÃ©rer les mÃ©thodes statiques pour les services utilitaires

### Base de donnÃ©es
- Utiliser PDO avec prepared statements
- Les repositories encapsulent l'accÃ¨s aux donnÃ©es
- Pas d'ORM, requÃªtes SQL directes pour la performance

### Gestion des erreurs
- Logs via Monolog dans `cronlog.txt` (ou `LOG_FILE_PATH` du .env)
- RÃ©ponses HTTP appropriÃ©es (200, 400, 401, 500)

## ğŸ”§ DÃ©veloppement

### Installation
```bash
composer install --no-dev   # Production
composer install            # DÃ©veloppement (avec PHPUnit)
```

### Tests
```bash
./vendor/bin/phpunit
```

### Serveur de dÃ©veloppement
```bash
php -S localhost:8080 -t public
```

## ğŸ¤– TÃ¢ches CRON

- `CleanDataCommand`: Nettoyage des anciennes donnÃ©es (toutes les 5 min recommandÃ©)
- `ProcessTasksCommand`: Traitement des tÃ¢ches pÃ©riodiques (toutes les heures)
- Verrouillage par `flock` pour Ã©viter les chevauchements
- Scripts wrapper dans `bin/` (si existants)

## ğŸ“Š Services mÃ©tier importants

- `SensorStatisticsService`: Calculs statistiques sur les capteurs
- `PumpService`: ContrÃ´le GPIO des pompes (aqua, tank)
- `NotificationService`: Envoi d'emails d'alerte
- `LogService`: Centralisation des logs Monolog

## ğŸš« Ã€ NE PAS FAIRE

1. âŒ Ne JAMAIS coder en dur les noms de tables (`ffp3Data`, `ffp3Data2`) â†’ utiliser `TableConfig`
2. âŒ Ne JAMAIS appeler `date_default_timezone_set()` dans les contrÃ´leurs â†’ timezone centralisÃ©
3. âŒ Ne PAS utiliser `mail()` directement â†’ utiliser `NotificationService`
4. âŒ Ne PAS crÃ©er de nouvelles connexions PDO manuelles â†’ utiliser `Database::getConnection()`
5. âŒ Ne PAS ignorer la validation de signature pour les endpoints POST d'API
6. âŒ Ne JAMAIS oublier d'incrÃ©menter la version aprÃ¨s chaque modification significative â†’ mettre Ã  jour `ffp3datas/VERSION` et `CHANGELOG.md`

## ğŸ“š Documentation de rÃ©fÃ©rence

- `README.md`: Documentation principale et roadmap
- `RESUME_MODIFICATIONS.md`: Historique de l'unification timezone
- `ENVIRONNEMENT_TEST.md`: Guide dÃ©taillÃ© des environnements PROD/TEST
- `TIMEZONE_UNIFICATION.md`: Documentation technique timezone (si existe)

## ğŸ¯ Workflow recommandÃ©

1. DÃ©velopper et tester sur l'environnement TEST (`/aquaponie-test`, tables `*2`)
2. **IncrÃ©menter la version** dans `ffp3datas/VERSION` et documenter dans `CHANGELOG.md`
3. Valider les modifications (tests unitaires, vÃ©rification graphiques, vÃ©rification affichage version)
4. DÃ©ployer en PROD (les routes et code sont dÃ©jÃ  partagÃ©s)

---

## ğŸ”„ RÃ¨gles supplÃ©mentaires spÃ©cifiques au projet

### â° Timezone - ParticularitÃ© gÃ©ographique

**IMPORTANT**: DiffÃ©rence entre timezone du projet et du serveur :
- ğŸŒ **Projet physique** (aquaponie, ESP32) : SituÃ© Ã  **Casablanca** (`Africa/Casablanca`)
- ğŸ–¥ï¸ **Serveur web** : HÃ©bergÃ© Ã  **Paris** (`Europe/Paris`)
- âš™ï¸ **Configuration actuelle** : `APP_TIMEZONE=Europe/Paris` (Ã  vÃ©rifier si conforme aux besoins)

**Ã€ considÃ©rer lors des dÃ©veloppements** :
- Les timestamps affichÃ©s sont actuellement en heure de Paris
- VÃ©rifier si les utilisateurs s'attendent Ã  voir l'heure de Casablanca
- Les ESP32 doivent envoyer des timestamps cohÃ©rents avec cette configuration
- En cas de modification de timezone, penser Ã  mettre Ã  jour Highcharts (moment-timezone)

### ğŸ“Œ Versionnage du projet

**ğŸš¨ OBLIGATOIRE - Ã€ FAIRE SYSTÃ‰MATIQUEMENT** : 

Ã€ chaque modification du code (ajout de fonctionnalitÃ©, correction de bug, amÃ©lioration) :

1. **IncrÃ©menter IMMÃ‰DIATEMENT la version** dans `ffp3datas/VERSION` selon Semantic Versioning (MAJOR.MINOR.PATCH)
   - MAJOR (x.0.0) : Changements incompatibles avec les versions prÃ©cÃ©dentes (breaking changes)
   - MINOR (0.x.0) : Ajout de fonctionnalitÃ©s rÃ©trocompatibles (nouvelles features)
   - PATCH (0.0.x) : Corrections de bugs et amÃ©liorations mineures

2. **Documenter la modification** dans `ffp3datas/CHANGELOG.md` avec :
   - Le numÃ©ro de version
   - La date
   - La description claire de la modification

3. **VÃ©rifier l'affichage** : La version doit Ãªtre visible sur toutes les pages web (header, footer ou coin de page)

**Processus Ã  suivre** :
```
Modification du code â†’ IncrÃ©menter VERSION â†’ Mettre Ã  jour CHANGELOG.md â†’ Tester â†’ Commit
```

**Exemples concrets** :
- Ajout d'un nouveau graphique â†’ MINOR (0.x.0)
- Correction d'un bug d'affichage â†’ PATCH (0.0.x)
- Changement de structure de base de donnÃ©es â†’ MAJOR (x.0.0)
- AmÃ©lioration de performance â†’ PATCH (0.0.x)

**âš ï¸ NE PAS oublier** : L'incrÃ©mentation de version fait partie intÃ©grante de chaque modification, pas une Ã©tape optionnelle !

<!-- Ajoutez d'autres rÃ¨gles personnalisÃ©es ci-dessous -->

