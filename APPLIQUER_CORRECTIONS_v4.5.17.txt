â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  INSTRUCTIONS D'APPLICATION - Correction doublons GPIO v4.5.17
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ OBJECTIF
-----------
Corriger le problÃ¨me des 4 lignes vides avec gpio=16 qui se crÃ©ent 
automatiquement dans la table ffp3Outputs.

âœ… CE QUI A Ã‰TÃ‰ FAIT
--------------------
1. âœ… Code modifiÃ© : src/Service/PumpService.php (INSERT ON DUPLICATE KEY UPDATE)
2. âœ… Scripts SQL crÃ©Ã©s dans le dossier migrations/
3. âœ… Documentation complÃ¨te rÃ©digÃ©e
4. âœ… VERSION incrÃ©mentÃ©e : 4.5.16 â†’ 4.5.17
5. âœ… CHANGELOG.md mis Ã  jour

ğŸ“‹ CE QU'IL VOUS RESTE Ã€ FAIRE
-------------------------------

Ã‰TAPE 1 : COMMIT ET PUSH DU CODE
---------------------------------
cd /chemin/vers/ffp3
git add .
git commit -m "fix: correction doublons GPIO v4.5.17 - ajout contrainte UNIQUE"
git push origin main

Ã‰TAPE 2 : PULL SUR LE SERVEUR
------------------------------
ssh votre-serveur
cd /var/www/html/ffp3  # (ou le chemin appropriÃ©)
git pull origin main

Ã‰TAPE 3 : APPLIQUER LES MIGRATIONS SQL
---------------------------------------

Option A - Via MySQL CLI (recommandÃ© si vous avez SSH) :
---------------------------------------------------------
ssh votre-serveur

# 1. Sauvegarde prÃ©ventive
mysqldump -u oliviera_iot -p oliviera_iot ffp3Outputs ffp3Outputs2 > backup_outputs_20251013.sql

# 2. Application de la correction des doublons
mysql -u oliviera_iot -p oliviera_iot < /var/www/html/ffp3/migrations/FIX_DUPLICATE_GPIO_ROWS.sql

# 3. Initialisation des GPIO avec noms (RECOMMANDÃ‰)
mysql -u oliviera_iot -p oliviera_iot < /var/www/html/ffp3/migrations/INIT_GPIO_BASE_ROWS.sql


Option B - Via phpMyAdmin :
----------------------------
1. Aller sur https://iot.olution.info/phpmyadmin (ou votre URL)
2. Se connecter avec les identifiants de la base
3. SÃ©lectionner la base "oliviera_iot"
4. Cliquer sur l'onglet "SQL"

5. SAUVEGARDE : Avant tout, exporter les tables
   - Onglet "Exporter"
   - SÃ©lectionner : ffp3Outputs, ffp3Outputs2
   - Format : SQL
   - TÃ©lÃ©charger le fichier

6. CORRECTION DES DOUBLONS :
   - Ouvrir le fichier : migrations/FIX_DUPLICATE_GPIO_ROWS.sql
   - Copier tout le contenu
   - Coller dans phpMyAdmin onglet SQL
   - Cliquer "ExÃ©cuter"
   - VÃ©rifier les messages de confirmation

7. INITIALISATION DES GPIO :
   - Ouvrir le fichier : migrations/INIT_GPIO_BASE_ROWS.sql
   - Copier tout le contenu
   - Coller dans phpMyAdmin onglet SQL
   - Cliquer "ExÃ©cuter"
   - VÃ©rifier que les GPIO s'affichent avec leurs noms


Ã‰TAPE 4 : VÃ‰RIFICATION
-----------------------
Dans phpMyAdmin, exÃ©cuter ces requÃªtes pour vÃ©rifier :

-- VÃ©rifier qu'il n'y a plus de doublons
SELECT gpio, COUNT(*) as nb 
FROM ffp3Outputs 
GROUP BY gpio 
HAVING COUNT(*) > 1;
-- RÃ©sultat attendu : 0 lignes


-- VÃ©rifier que GPIO 16 a maintenant un nom
SELECT gpio, name, board, state 
FROM ffp3Outputs 
WHERE gpio = 16;
-- RÃ©sultat attendu : 1 ligne "Pompe Aquarium"


-- VÃ©rifier que la contrainte UNIQUE existe
SHOW INDEXES FROM ffp3Outputs 
WHERE Key_name = 'unique_gpio';
-- RÃ©sultat attendu : 1 ligne


Ã‰TAPE 5 : TEST EN PRODUCTION
-----------------------------
1. Aller sur https://iot.olution.info/ffp3/ffp3control/securecontrol/
2. VÃ©rifier que l'interface de contrÃ´le fonctionne
3. VÃ©rifier que les noms des GPIO s'affichent correctement
4. Attendre 5-10 minutes (le temps que le CRON s'exÃ©cute)
5. Retourner dans phpMyAdmin et vÃ©rifier qu'AUCUNE nouvelle ligne vide 
   ne s'est crÃ©Ã©e pour GPIO 16


Ã‰TAPE 6 : SURVEILLANCE (24-48h)
--------------------------------
- Surveiller les logs CRON : cronlog.txt
- VÃ©rifier pÃ©riodiquement dans phpMyAdmin qu'il n'y a pas de doublons
- Tester les fonctionnalitÃ©s de contrÃ´le des pompes


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸  EN CAS DE PROBLÃˆME
----------------------
1. Consulter migrations/README.md (section DÃ©pannage)
2. Consulter CORRECTION_DOUBLONS_GPIO_v4.5.17.md (documentation complÃ¨te)
3. Restaurer le backup si nÃ©cessaire :
   mysql -u oliviera_iot -p oliviera_iot < backup_outputs_20251013.sql

ğŸ“ SUPPORT
----------
Si vous rencontrez un problÃ¨me :
1. VÃ©rifier les logs : cronlog.txt
2. VÃ©rifier les erreurs MySQL dans phpMyAdmin
3. Consulter la documentation dans migrations/README.md

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… CHECKLIST FINALE
-------------------
[ ] Code commitÃ© et pushÃ© sur Git
[ ] Code pulled sur le serveur
[ ] Sauvegarde SQL effectuÃ©e
[ ] Migration FIX_DUPLICATE_GPIO_ROWS.sql appliquÃ©e
[ ] Migration INIT_GPIO_BASE_ROWS.sql appliquÃ©e
[ ] VÃ©rification : aucun doublon restant
[ ] VÃ©rification : contrainte UNIQUE prÃ©sente
[ ] VÃ©rification : GPIO 16 a un nom "Pompe Aquarium"
[ ] Test interface de contrÃ´le
[ ] Attente 10 min et vÃ©rification qu'aucun doublon ne se crÃ©e
[ ] Surveillance des logs pendant 24h

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‰ Une fois tout vÃ©rifiÃ©, le problÃ¨me sera DÃ‰FINITIVEMENT RÃ‰SOLU !

La contrainte UNIQUE empÃªchera toute future crÃ©ation de doublons, 
mÃªme en cas de bug dans le code.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

